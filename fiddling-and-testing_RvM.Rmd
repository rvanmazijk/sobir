---
title: "$Z$-statistics and $p$-values for boundary line analysis in `sobir`"
author: "Ruan van Mazijk"
date: "`r format(Sys.Date(), '%e %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sobir)
library(tidyverse)
```

```{r simulate-data, include=FALSE}
set.seed(1234)
xdat <- rnorm(100, 0, 1)
ydat <- rnorm(100, 0, 1)
```

Let us consider some simulated data, where both $X$ and $Y$ follow a standard normal distribution --- i.e. $\sim N(\mu = 0, \sigma = 1)$.
Simulating 100 points, the 'boundaries' of this data set look like this:

```{r plot-data, echo=FALSE, fig.width=4}
bpts <- extract_bpts(xdat, ydat)
bpts_plot(bpts) +
  labs(
    x = bquote(italic(X)),
    y = bquote(italic(Y)),
    subtitle = bquote(italic(n) == 100)
  ) +
  coord_equal()
```

(Figure generated by mostly `sobir`.)

Now let's run the permutations.
For the sake of time, I'll permute the data (without replacement) 10 times:

```{r permute-data}
perm_area_result <- perm_area(xdat, ydat, nsim = 10)
perm_area_result
```

Note, the $p$-value (of the observed magnitude of the area of the top-left no-data zone) here is that calculated by the R-package `statmod`.
Disregard that for now.
For the time being, I'd like to intuit what I think calculating $Z$-statistic would look like in this situation.

There are two approaches to $Z$ in my mind: i) the difference between the observed area and mean of the permuted areas and ii) the rank of the observed area among the permuted areas.

```{r extract-obs-and-perm-areas, include=FALSE}
obs_area <- perm_area_result$data %>%
  filter(source == "obs") %>%
  pull(val)
perm_areas <- perm_area_result$data %>%
  filter(source == "sim") %>%
  pull(val)
```

First, let's look at the means-method:

```{r calculate-p-from-means}
z <- (obs_area - mean(perm_areas))/sd(perm_areas)
z
pnorm(z, lower.tail = FALSE)
```

Second, let's look at the rank-method (which is non-parametric, unlike the first method which assumes the permuted areas follow a normal distribution (I'm not saying they don't, I'm just saying I'm not 100% sure they always will)):

```{r calculate-p-from-ranks}
ranks <- rank(c(obs_area, perm_areas))
# We want the "p-value" for the 11th ranking value out of 11 values to be 1/11 (= ~0.091)
# Hence:
(length(ranks) - ranks[[1]] + 1)/length(ranks)
```

In mathematical notation, if the observed area $a_\mathrm{obs}$ ranks 11th (i.e. greatest) out of the set of 11 areas $a$ ($= \{ a_\mathrm{obs}, \{ a_\mathrm{perm} \} \}$), we *want* the "$p$-value" here, conceptually, to equal $\frac{1}{11}$ (= 0.091).
So,

$$
  p = \frac{1}{11} = \frac{11 - 11 + 1}{11} \approx 0.091
$$

More generally, for $n_\mathrm{perm}$ permuted areas, the "$p$-value" for $a_\mathrm{obs}$ is based on its rank $r_\mathrm{obs}$ among the permuted areas:

$$
  p(a_\mathrm{obs}|a_\mathrm{perm}) = \frac{(n_\mathrm{perm} + 1) - r_\mathrm{obs} + 1}{n_\mathrm{perm} + 1}
$$

```{r, eval=FALSE}
perm_area_result$data %>%
  ungroup() %>%
  arrange(val) %>%
  mutate(rank = rank(val)) %>%
  mutate(extremity = ifelse(rank <= ceiling(n()/2),
    n() - rank,
    rank
  )) %>%
  mutate(p_twosided = (n() - extremity + 1)/n()) %>%
  data.frame()
```

But I digress.

```{r plot-hist}
area <- perm_area_result$data %>%
  split(.$source) %>%
  map(pull, val)

boxplot(area$sim)
abline(h = area$obs, lty = "dashed")

hist(area$sim, breaks = 50, sub = "(50 bins)")
abline(v = area$obs, lty = "dashed")
```
